<!DOCTYPE html>
<html lang=en>
<head>
<!-- This file was generated by tohtml from chap-io/io-2.tex -->
<!-- with the command
tohtml -default -basedef mpi3defs.txt -numbers -indexname myindex -dosnl -htables -quietlatex -allgif -endpage mpi3-forum-tail.htm -Wnoredef -o mpi31-report.tex mpi-report.tex 
-->
<title>User-Defined Data Representations</title>
</head>
<body style="background-color:#FFFFFF">
<hr><h2><span id="Node334">301. User-Defined Data Representations</span></h2>
<a href="node333.htm#Node333"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node331.htm#Node331"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node334.htm#Node335"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node331.htm#Node331"> File Interoperability</a>
<b>Next: </b><a href="node334.htm#Node335"> Extent Callback</a>
<b>Previous: </b><a href="node333.htm#Node333"> External Data Representation: ``external32''</a>
<p>
  
  
<P> 
There are two situations that cannot be handled by the required  
representations:  
<ol> 
 
1. a user wants to write a file in a representation unknown  
to the implementation, and  
 
<br> 
2. a user wants to read a file written in a representation unknown  
to the implementation.  
</ol> 
User-defined data representations allow the user to insert a third  
party converter into the I/O stream to do the data representation conversion.  
<P> 
<TABLE><TR><TD COLSPAN=2>MPI_REGISTER_DATAREP(datarep, read_conversion_fn, write_conversion_fn,  dtype_file_extent_fn, extra_state)</TD></TR>  
<TR><TD> IN datarep</TD><TD>data representation identifier (string)</TD></TR>  
<TR><TD> IN read_conversion_fn</TD><TD>function invoked to convert from file representation to native representation (function)</TD></TR>  
<TR><TD> IN write_conversion_fn</TD><TD>function invoked to convert from native representation to file representation (function)</TD></TR>  
<TR><TD> IN dtype_file_extent_fn</TD><TD>function invoked to get the extent of a datatype as represented in the file (function)</TD></TR>  
<TR><TD> IN extra_state</TD><TD>extra state</TD></TR>  
</TABLE>  
<P> 
 <tt> int MPI_Register_datarep(const char *datarep, MPI_Datarep_conversion_function *read_conversion_fn, MPI_Datarep_conversion_function *write_conversion_fn, MPI_Datarep_extent_function *dtype_file_extent_fn, void *extra_state) <br></tt>  
 <tt> MPI_Register_datarep(datarep, read_conversion_fn, write_conversion_fn, dtype_file_extent_fn, extra_state, ierror) <br> CHARACTER(LEN=*), INTENT(IN) :: datarep <br>PROCEDURE(MPI_Datarep_conversion_function) :: read_conversion_fn <br>PROCEDURE(MPI_Datarep_conversion_function) :: write_conversion_fn <br>PROCEDURE(MPI_Datarep_extent_function) :: dtype_file_extent_fn <br>INTEGER(KIND=MPI_ADDRESS_KIND), INTENT(IN) :: extra_state <br>INTEGER, OPTIONAL, INTENT(OUT) :: ierror <br></tt>  
 <tt> MPI_REGISTER_DATAREP(DATAREP, READ_CONVERSION_FN, WRITE_CONVERSION_FN, DTYPE_FILE_EXTENT_FN, EXTRA_STATE, IERROR) <br> CHARACTER*(*) DATAREP <br>EXTERNAL READ_CONVERSION_FN, WRITE_CONVERSION_FN, DTYPE_FILE_EXTENT_FN <br>INTEGER(KIND=MPI_ADDRESS_KIND) EXTRA_STATE <br>INTEGER IERROR <br></tt>  
  
<P> 
The call associates <font face="sans-serif"> read_conversion_fn</font>,  
<font face="sans-serif"> write_conversion_fn</font>, and  
<font face="sans-serif"> dtype_file_extent_fn</font>  
with the data representation identifier <font face="sans-serif"> datarep</font>.  
<font face="sans-serif"> datarep</font> can then be used as an argument  
to <font face="sans-serif"> MPI_FILE_SET_VIEW</font>, causing  
subsequent data access operations to call the conversion functions  
to convert all data items accessed between file data representation  
and native representation.  
<font face="sans-serif"> MPI_REGISTER_DATAREP</font> is a local operation and only registers the  
data representation  
for the calling <font face="sans-serif"> MPI</font> process.  
If <font face="sans-serif"> datarep</font> is already defined,  
an error in the error class <font face="sans-serif"> MPI_ERR_DUP_DATAREP</font> is raised  
using the default file error handler (see Section <a href="node351.htm#Node351">I/O Error Handling 
</a>).  
The length of a data representation string is limited to the value of  
<font face="sans-serif">  MPI_MAX_DATAREP_STRING</font>.  
<font face="sans-serif">  MPI_MAX_DATAREP_STRING</font> must have a value of at least 64.  
No routines are provided to delete data representations and  
free the associated resources;  
it is not expected that an application  
will generate them in significant numbers.  
<P> 
<ul> 
</ul> 

<P>
<hr>
<a href="node333.htm#Node333"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node331.htm#Node331"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node334.htm#Node335"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node331.htm#Node331"> File Interoperability</a>
<b>Next: </b><a href="node334.htm#Node335"> Extent Callback</a>
<b>Previous: </b><a href="node333.htm#Node333"> External Data Representation: ``external32''</a>
<p>
<hr><h3><span id="Node335">301.1. Extent Callback</span></h3>
<a href="node334.htm#Node334"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node334.htm#Node334"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node334.htm#Node336"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node334.htm#Node334"> User-Defined Data Representations</a>
<b>Next: </b><a href="node334.htm#Node336"> Datarep Conversion Functions</a>
<b>Previous: </b><a href="node334.htm#Node334"> User-Defined Data Representations</a>
<p>
 <tt> typedef int MPI_Datarep_extent_function(MPI_Datatype datatype, MPI_Aint *file_extent, void *extra_state); <br></tt>  
 <tt> SUBROUTINE MPI_Datarep_extent_function(datatype, extent, extra_state, ierror) <br> TYPE(MPI_Datatype) :: datatype <br>INTEGER(KIND=MPI_ADDRESS_KIND) :: extent, extra_state <br>INTEGER :: ierror  <br></tt>  
 <tt> SUBROUTINE DATAREP_EXTENT_FUNCTION(DATATYPE, EXTENT, EXTRA_STATE, IERROR)<br> INTEGER DATATYPE, IERROR <br>INTEGER(KIND=MPI_ADDRESS_KIND) EXTENT, EXTRA_STATE <br></tt>  
  
<P> 
The function <font face="sans-serif"> dtype_file_extent_fn</font>  
must return, in <font face="sans-serif"> file_extent</font>, the number of bytes  
required to store <font face="sans-serif"> datatype</font> in the file representation.  
The function is passed, in <font face="sans-serif"> extra_state</font>,  
the argument that was passed to the <font face="sans-serif"> MPI_REGISTER_DATAREP</font> call.  
<font face="sans-serif"> MPI</font> will only call this routine with predefined datatypes  
employed by the user.  
<P> 

<P>
<hr>
<a href="node334.htm#Node334"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node334.htm#Node334"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node334.htm#Node336"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node334.htm#Node334"> User-Defined Data Representations</a>
<b>Next: </b><a href="node334.htm#Node336"> Datarep Conversion Functions</a>
<b>Previous: </b><a href="node334.htm#Node334"> User-Defined Data Representations</a>
<p>
<hr><h3><span id="Node336">301.2. Datarep Conversion Functions</span></h3>
<a href="node334.htm#Node335"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node334.htm#Node334"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node337.htm#Node337"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node334.htm#Node334"> User-Defined Data Representations</a>
<b>Next: </b><a href="node337.htm#Node337"> Matching Data Representations</a>
<b>Previous: </b><a href="node334.htm#Node335"> Extent Callback</a>
<p>
 <tt> typedef int MPI_Datarep_conversion_function(void *userbuf, MPI_Datatype datatype, int count, void *filebuf, MPI_Offset position, void *extra_state); <br></tt>  
<P> 
 <tt> SUBROUTINE MPI_Datarep_conversion_function(userbuf, datatype, count, filebuf, position, extra_state, ierror) <br>  USE, INTRINSIC :: ISO_C_BINDING, ONLY : C_PTR <br>TYPE(C_PTR), VALUE :: userbuf, filebuf <br>TYPE(MPI_Datatype) :: datatype <br>INTEGER :: count, ierror <br>INTEGER(KIND=MPI_OFFSET_KIND) :: position <br>INTEGER(KIND=MPI_ADDRESS_KIND) :: extra_state <br></tt>  
 <tt> SUBROUTINE DATAREP_CONVERSION_FUNCTION(USERBUF, DATATYPE, COUNT, FILEBUF, POSITION, EXTRA_STATE, IERROR)<br> &lt;TYPE&gt; USERBUF(*), FILEBUF(*) <br>INTEGER COUNT, DATATYPE, IERROR <br>INTEGER(KIND=MPI_OFFSET_KIND) POSITION <br>INTEGER(KIND=MPI_ADDRESS_KIND) EXTRA_STATE <br></tt>  
  
<P> 
The function   
<font face="sans-serif"> read_conversion_fn</font>   
must convert from  
file data representation to native representation.  
Before calling this routine,  
<font face="sans-serif"> MPI</font> allocates and fills <font face="sans-serif"> filebuf</font> with <font face="sans-serif"> count</font> <br>  
contiguous data items.  
The type of each data item matches the  
corresponding entry for the predefined datatype  
in the type signature of <font face="sans-serif"> datatype</font>.  
The function is passed, in <font face="sans-serif"> extra_state</font>,  
the argument that was passed to the <font face="sans-serif"> MPI_REGISTER_DATAREP</font> call.  
The function must copy all <font face="sans-serif"> count</font> data items from <font face="sans-serif"> filebuf</font>  
to <font face="sans-serif"> userbuf</font> in the distribution described by <font face="sans-serif"> datatype</font>,  
converting each data item  
from file representation to native representation.  
<font face="sans-serif"> datatype</font> will be equivalent to the datatype that the user  
passed to the   
read  
function.  
If the size of <font face="sans-serif"> datatype</font> is less than the size  
of the <font face="sans-serif"> count</font> data items, the conversion function must treat  
<font face="sans-serif"> datatype</font> as being contiguously tiled over the <font face="sans-serif"> userbuf</font>.  
The conversion function must  
begin storing converted data at the location in <font face="sans-serif"> userbuf</font>  
specified by <font face="sans-serif"> position</font> into the (tiled) <font face="sans-serif"> datatype</font>.  
<P> 
 
<br> 
<em> Advice to users.</em>  
<P> 
Although the conversion functions have similarities  
to <font face="sans-serif"> MPI_PACK</font> and   
<font face="sans-serif"> MPI_UNPACK</font>,  
one should note the differences in the use  
of the arguments <font face="sans-serif"> count</font> and <font face="sans-serif"> position</font>.  
In the conversion functions,  
<font face="sans-serif"> count</font> is a count of data items  
(i.e., count of typemap entries of <font face="sans-serif"> datatype</font>),  
and <font face="sans-serif"> position</font> is an index into this typemap.  
In <font face="sans-serif"> MPI_PACK</font>,  
<font face="sans-serif"> incount</font> refers to the number of whole <font face="sans-serif"> datatype</font>s,  
and <font face="sans-serif"> position</font> is a number of bytes.  
 (<em> End of advice to users.</em>) <br> 
 
<br> 
<em> Advice  
        to implementors.</em>  
<P> 
A converted read operation could be implemented as follows:  
<P> 
<ol> 
 
1. Get file extent of all data items  
 
<br> 
2. Allocate a filebuf large enough to hold all count data items  
 
<br> 
3. Read data from file into filebuf  
 
<br> 
4. Call <font face="sans-serif"> read_conversion_fn</font> to convert data and place it into userbuf  
 
<br> 
5. Deallocate filebuf  
</ol> 
 (<em> End of advice to implementors.</em>) <br> 
If <font face="sans-serif"> MPI</font> cannot allocate a buffer large enough to hold  
all the data to be converted from a read operation, it may  
call the conversion function repeatedly using the same <font face="sans-serif"> datatype</font>  
and <font face="sans-serif"> userbuf</font>,  
and reading successive chunks of data to be  
converted in <font face="sans-serif"> filebuf</font>.  For the first call (and in  
the case when all the data to be converted fits into  
<font face="sans-serif"> filebuf</font>), <font face="sans-serif"> MPI</font> will call the function with   
<font face="sans-serif"> position</font> set to zero.  Data converted during this  
call will be stored in the <font face="sans-serif"> userbuf</font> according to  
the first <font face="sans-serif"> count</font> data items in <font face="sans-serif"> datatype</font>.  Then  
in subsequent calls to the conversion function, <font face="sans-serif"> MPI</font> will  
increment the value in <font face="sans-serif"> position</font> by the <font face="sans-serif"> count</font> of  
items converted in the previous  
call, and the <font face="sans-serif"> userbuf</font> pointer will be unchanged.   
<P> 
 
<br> 
<em> Rationale.</em>  
<P> 
Passing the conversion function a position and one datatype for the transfer  
allows the conversion function to decode the datatype only once and  
cache an internal representation of it on the datatype.  
Then on subsequent calls, the conversion function can use the <font face="sans-serif"> position</font>  
to quickly find its place in the datatype and continue  
storing converted data where it left off at the end of the previous call.  
 (<em> End of rationale.</em>) <br> 
 
<br> 
<em> Advice to users.</em>  
<P> 
Although the conversion function may usefully cache an  
internal representation on the datatype, it should not cache  
any state information specific to an ongoing conversion  
operation, since it is possible for the same datatype to  
be used concurrently in multiple conversion operations.  
 (<em> End of advice to users.</em>) <br> 
The function <font face="sans-serif"> write_conversion_fn</font> must convert from  
native representation to file data representation.  
Before calling this routine,  
<font face="sans-serif"> MPI</font> allocates <font face="sans-serif"> filebuf</font> of a size large enough to hold <font face="sans-serif"> count</font>  
contiguous data items.  
The type of each data item matches the  
corresponding entry for the predefined datatype  
in the type signature of <font face="sans-serif"> datatype</font>.  
The function must copy <font face="sans-serif"> count</font> data items from  
<font face="sans-serif"> userbuf</font> in the distribution described by   
<font face="sans-serif"> datatype</font>,  
to a contiguous distribution in <font face="sans-serif"> filebuf</font>, converting each data item  
from native representation to file representation.  
If the size of <font face="sans-serif"> datatype</font> is less than the size  
of <font face="sans-serif"> count</font>  
data items,  
the conversion function must treat  
<font face="sans-serif"> datatype</font> as being contiguously tiled over the  
<font face="sans-serif"> userbuf</font>.  
<P> 
The function must  
begin copying at the location in <font face="sans-serif"> userbuf</font> specified by  
<font face="sans-serif"> position</font> into the (tiled) <font face="sans-serif"> datatype</font>.  
<font face="sans-serif"> datatype</font> will be equivalent to the datatype  
that the user passed to the   
write   
function.  
The function is passed, in <font face="sans-serif"> extra_state</font>,  
the argument that was passed to the <font face="sans-serif"> MPI_REGISTER_DATAREP</font> call.  
<P> 
The predefined constant   
<font face="sans-serif"> MPI_CONVERSION_FN_NULL</font>   
may be used as either  
<font face="sans-serif"> write_conversion_fn</font> or <font face="sans-serif"> read_conversion_fn</font>.  In that  
case, <font face="sans-serif"> MPI</font> will  
not attempt to invoke <font face="sans-serif"> write_conversion_fn</font> or   
<font face="sans-serif"> read_conversion_fn</font>, respectively, but will perform   
the requested data access using the native data representation.  
<P> 
  
<P> 
An <font face="sans-serif"> MPI</font> implementation must ensure that all data accessed is converted,  
either by using a filebuf large enough to hold all the requested  
data items  
or else by making repeated calls to the conversion function  
with the same <font face="sans-serif"> datatype</font> argument and appropriate values for  
<font face="sans-serif"> position</font>.  
<P> 
An implementation will only invoke the callback routines in this section  
  
(<font face="sans-serif"> read_conversion_fn</font>, <font face="sans-serif"> write_conversion_fn</font>,  
and <font face="sans-serif"> dtype_file_extent_fn</font>)  
when one of the read or write routines in Section <a href="node318.htm#Node318">Data Access 
</a>,  
or <font face="sans-serif"> MPI_FILE_GET_TYPE_EXTENT</font> is called by the user.    
<font face="sans-serif"> dtype_file_extent_fn</font> will only be passed  
predefined datatypes employed by the user.  
The conversion functions will only be passed datatypes equivalent to those  
that the user has passed to one of the routines noted above.  
<P> 
The conversion functions must be reentrant.  
User defined data representations are restricted  
to use byte alignment for all types.  
Furthermore, it is erroneous for the conversion functions to  
call any collective routines or to free <font face="sans-serif"> datatype</font>.  
<P> 
The conversion functions should return an error code.  
If the returned error  
code has a value other than <font face="sans-serif">  MPI_SUCCESS</font>, the  
implementation will raise an error in the class <font face="sans-serif"> MPI_ERR_CONVERSION</font>.  
<P> 

<P>
<hr>
<a href="node334.htm#Node335"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node334.htm#Node334"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node337.htm#Node337"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node334.htm#Node334"> User-Defined Data Representations</a>
<b>Next: </b><a href="node337.htm#Node337"> Matching Data Representations</a>
<b>Previous: </b><a href="node334.htm#Node335"> Extent Callback</a>
<p>
<HR>
Return to <A HREF="node523.htm">MPI-3.1 Standard Index</A><BR>
Return to <A HREF="http://www.mpi-forum.org/index.html">MPI Forum Home Page</A><BR>
<HR>
<FONT SIZE=-1>(Unofficial) MPI-3.1 of June 4, 2015<BR>
HTML Generated on June 4, 2015
</FONT>
</body>
</html>
