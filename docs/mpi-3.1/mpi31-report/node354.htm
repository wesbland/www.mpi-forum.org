<!DOCTYPE html>
<html lang=en>
<head>
<!-- This file was generated by tohtml from chap-io/io-2.tex -->
<!-- with the command
tohtml -default -basedef mpi3defs.txt -numbers -indexname myindex -dosnl -htables -quietlatex -allgif -endpage mpi3-forum-tail.htm -Wnoredef -o mpi31-report.tex mpi-report.tex 
-->
<title>Double Buffering with Split Collective I/O</title>
</head>
<body style="background-color:#FFFFFF">
<hr><h2><span id="Node354">318. Double Buffering with Split Collective I/O</span></h2>
<a href="node353.htm#Node353"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node353.htm#Node353"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node355.htm#Node355"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node353.htm#Node353"> Examples</a>
<b>Next: </b><a href="node355.htm#Node355"> Subarray Filetype Constructor</a>
<b>Previous: </b><a href="node353.htm#Node353"> Examples</a>
<p>
  
This example shows how to overlap computation and output.  
The computation is performed by the function <tt>compute_buffer()</tt>.  
<P> 
<br> 
<pre><tt>/*========================================================================= 
 * 
 * Function:            double_buffer 
 * 
 * Synopsis: 
 *      void double_buffer( 
 *              MPI_File fh,                            ** IN 
 *              MPI_Datatype buftype,                   ** IN 
 *              int bufcount                            ** IN 
 *      ) 
 * 
 * Description: 
 *      Performs the steps to overlap computation with a collective write 
 *      by using a double-buffering technique. 
 * 
 * Parameters: 
 *      fh                 previously opened MPI file handle 
 *      buftype            MPI datatype for memory layout 
 *                         (Assumes a compatible view has been set on fh) 
 *      bufcount           # buftype elements to transfer 
 *------------------------------------------------------------------------*/ 
 
/* this macro switches which buffer "x" is pointing to */ 
#define TOGGLE_PTR(x) (((x)==(buffer1)) ? (x=buffer2) : (x=buffer1)) 
 
void double_buffer(  MPI_File fh, MPI_Datatype buftype, int bufcount) 
{ 
 
   MPI_Status status;         /* status for MPI calls */ 
   float *buffer1, *buffer2;  /* buffers to hold results */ 
   float *compute_buf_ptr;    /* destination  buffer */ 
                              /*   for computing */ 
   float *write_buf_ptr;      /* source for writing */ 
   int done;                  /* determines when to quit */ 
 
   /* buffer initialization */ 
   buffer1 = (float *) 
                      malloc(bufcount*sizeof(float)); 
   buffer2 = (float *) 
                      malloc(bufcount*sizeof(float)); 
   compute_buf_ptr = buffer1;    /* initially point to buffer1 */ 
   write_buf_ptr   = buffer1;    /* initially point to buffer1 */ 
 
 
   /* DOUBLE-BUFFER prolog:  
    *   compute buffer1; then initiate writing buffer1 to disk  
    */ 
   compute_buffer(compute_buf_ptr, bufcount, &amp;done); 
   MPI_File_write_all_begin(fh, write_buf_ptr, bufcount, buftype); 
 
   /* DOUBLE-BUFFER steady state:  
    *  Overlap writing old results from buffer pointed to by write_buf_ptr  
    *  with computing new results into buffer pointed to by compute_buf_ptr. 
    * 
    *  There is always one write-buffer and one compute-buffer in use  
    *  during steady state. 
    */ 
   while (!done) { 
      TOGGLE_PTR(compute_buf_ptr); 
      compute_buffer(compute_buf_ptr, bufcount, &amp;done); 
      MPI_File_write_all_end(fh, write_buf_ptr, &amp;status); 
      TOGGLE_PTR(write_buf_ptr); 
      MPI_File_write_all_begin(fh, write_buf_ptr, bufcount, buftype); 
   } 
 
   /* DOUBLE-BUFFER epilog: 
    *   wait for final write to complete. 
    */ 
   MPI_File_write_all_end(fh, write_buf_ptr, &amp;status); 
 
 
   /* buffer cleanup */ 
   free(buffer1); 
   free(buffer2); 
} 
</tt></pre> 

<P>
<hr>
<a href="node353.htm#Node353"><img width=16 height=16 src="previous.gif" alt="Previous"></a><a href="node353.htm#Node353"><img width=16 height=16 src="up.gif" alt="Up"></a><a href="node355.htm#Node355"><img width=16 height=16 src="next.gif" alt="Next"></a><br>
<b>Up: </b><a href="node353.htm#Node353"> Examples</a>
<b>Next: </b><a href="node355.htm#Node355"> Subarray Filetype Constructor</a>
<b>Previous: </b><a href="node353.htm#Node353"> Examples</a>
<p>
<HR>
Return to <A HREF="node523.htm">MPI-3.1 Standard Index</A><BR>
Return to <A HREF="http://www.mpi-forum.org/index.html">MPI Forum Home Page</A><BR>
<HR>
<FONT SIZE=-1>(Unofficial) MPI-3.1 of June 4, 2015<BR>
HTML Generated on June 4, 2015
</FONT>
</body>
</html>
